<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マスターデータ管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .family-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem; /* p-3 p-4 */
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .family-content {
            padding: 1rem; /* p-4 */
        }
        .member-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.5rem; /* gap-2 */
        }
        @media (min-width: 768px) {
            .member-grid {
                grid-template-columns: repeat(7, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="container mx-auto max-w-6xl bg-white p-6 rounded-lg shadow">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">マスターデータ管理</h1>
        <p class="mb-4 text-gray-600"><a href="index.html" class="text-blue-600 underline">&laquo; メインアプリに戻る</a></p>

        <!-- メッセージエリア -->
        <div id="message" class="hidden p-4 mb-4 border rounded-lg" role="alert">
            <span id="message-text"></span>
            <button id="message-close" type="button" class="float-right font-bold text-lg leading-none">&times;</button>
        </div>

        <!-- データインポート/エクスポート -->
        <section class="mb-6 p-4 border rounded-lg bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">データのエクスポート / インポート</h2>
            <div class="flex flex-wrap gap-2">
                <!-- ★ 修正: ボタンサイズ変更 -->
                <button id="export-master-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded-lg shadow transition duration-200 text-sm">
                    マスターを保存 (JSON)
                </button>
                <label for="import-master-input" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1.5 px-3 rounded-lg shadow transition duration-200 cursor-pointer text-center text-sm">
                    マスターを読み込む (JSON)
                </label>
                <input type="file" id="import-master-input" class="hidden" accept=".json">
            </div>
            <p class="text-sm text-gray-500 mt-2">
                現在の家族・車・駐車場（グラウンド）の全マスターデータをJSONファイルとして保存（ダウンロード）したり、ファイルから読み込んだりできます。
            </p>
        </section>

        <!-- 家族リスト -->
        <section class="mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">家族データ</h2>
            <div id="family-list" class="space-y-4">
                <p id="family-loading-message" class="text-gray-500">家族データを読み込み中...</p>
                <!-- JSで描画 -->
            </div>
            <!-- ★ 修正: ボタンサイズ変更 -->
            <button id="add-family-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow transition duration-200 text-sm">
                新しい家族を追加
            </button>
        </section>

        <!-- 車リスト -->
        <section class="mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">車データ</h2>
            <div id="car-list" class="space-y-4">
                <p id="car-loading-message" class="text-gray-500">車データを読み込み中...</p>
                <!-- JSで描画 -->
            </div>
            <!-- ★ 修正: ボタンサイズ変更 -->
            <button id="add-car-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow transition duration-200 text-sm">
                新しい車を追加
            </button>
        </section>

        <!-- ★ 新規: 駐車場（グラウンド）リスト -->
        <section class="mb-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-3">駐車場（グラウンド）データ</h2>
            <div id="parking-list" class="space-y-4">
                <p id="parking-loading-message" class="text-gray-500">駐車場データを読み込み中...</p>
                <!-- JSで描画 -->
            </div>
            <!-- ★ 修正: ボタンサイズ変更 -->
            <button id="add-parking-button" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded-lg shadow transition duration-200 text-sm">
                新しい駐車場を追加
            </button>
        </section>

    </div>

    <script type="module">
        import * as db from './db.js';

        // --- DOM参照 ---
        const familyListEl = document.getElementById('family-list');
        const carListEl = document.getElementById('car-list');
        const parkingListEl = document.getElementById('parking-list'); // ★ 新規
        const addFamilyButton = document.getElementById('add-family-button');
        const addCarButton = document.getElementById('add-car-button');
        const addParkingButton = document.getElementById('add-parking-button'); // ★ 新規
        const exportMasterButton = document.getElementById('export-master-button');
        const importMasterInput = document.getElementById('import-master-input');
        const messageContainer = document.getElementById('message');
        const messageText = document.getElementById('message-text');
        const messageClose = document.getElementById('message-close');
        const familyLoadingMessage = document.getElementById('family-loading-message');
        const carLoadingMessage = document.getElementById('car-loading-message');
        const parkingLoadingMessage = document.getElementById('parking-loading-message'); // ★ 新規

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadFamilies();
                await loadCars();
                await loadParking(); // ★ 新規
            } catch (err) {
                console.error("マスターデータ管理ページの読み込みエラー:", err);
                familyLoadingMessage.textContent = "データの読み込みに失敗しました。";
                familyLoadingMessage.classList.add('text-red-500');
                carLoadingMessage.textContent = "データの読み込みに失敗しました。";
                carLoadingMessage.classList.add('text-red-500');
                parkingLoadingMessage.textContent = "データの読み込みに失敗しました。"; // ★ 新規
                parkingLoadingMessage.classList.add('text-red-500'); // ★ 新規
                showErrorMessage(`データベースの読み込みに失敗しました: ${err.message}`);
            }

            addFamilyButton.addEventListener('click', handleAddFamily);
            familyListEl.addEventListener('click', handleFamilyAction);
            familyListEl.addEventListener('input', handleMemberInput);

            addCarButton.addEventListener('click', handleAddCar);
            carListEl.addEventListener('click', handleCarAction);
            carListEl.addEventListener('input', handleCarInput);
            
            addParkingButton.addEventListener('click', handleAddParking); // ★ 新規
            parkingListEl.addEventListener('click', handleParkingAction); // ★ 新規
            parkingListEl.addEventListener('input', handleParkingInput); // ★ 新規
            
            exportMasterButton.addEventListener('click', handleExportMasterData);
            importMasterInput.addEventListener('change', handleImportMasterData);
            messageClose.addEventListener('click', hideMessage);
        });

        // --- 家族データの読み込みと描画 ---
        async function loadFamilies() {
            try {
                const families = await db.getAllFamilies();
                families.sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
                renderFamilies(families);
            } catch (err) {
                console.error('Failed to load families:', err);
                familyLoadingMessage.textContent = "家族データの読み込みに失敗しました。";
                familyLoadingMessage.classList.add('text-red-500');
            }
        }

        function renderFamilies(families) {
            familyListEl.innerHTML = '';
            if (families.length === 0) {
                familyLoadingMessage.textContent = "データがありません。「新しい家族を追加」ボタンから登録してください。";
                familyListEl.appendChild(familyLoadingMessage);
                return;
            }
            families.forEach((family, index) => {
                const familyCard = renderFamily(family, index, families.length);
                familyListEl.appendChild(familyCard);
            });
        }

        function renderFamily(family, index, totalCount) {
            const familyCard = document.createElement('div');
            familyCard.className = 'bg-white border rounded-lg shadow';
            familyCard.dataset.familyId = family.familyName; 

            const membersHtml = family.members.map(member => `
                <div class="p-2 border rounded bg-gray-50 member-grid">
                    <input type="text" data-member-id="${member.id}" data-field="name" value="${member.name}" placeholder="名前" class="col-span-3 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <select data-member-id="${member.id}" data-field="type" class="col-span-2 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                        <option value="選手" ${member.type === '選手' ? 'selected' : ''}>選手</option>
                        <option value="保護者" ${member.type === '保護者' ? 'selected' : ''}>保護者</option>
                        <option value="兄弟" ${member.type === '兄弟' ? 'selected' : ''}>兄弟</option>
                        <option value="その他" ${member.type === 'その他' ? 'selected' : ''}>その他</option>
                    </select>
                    <input type="text" data-member-id="${member.id}" data-field="data.grade" value="${member.data.grade || ''}" placeholder="学年" class="col-span-1 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <input type="text" data-member-id="${member.id}" data-field="data.school" value="${member.data.school || ''}" placeholder="学校" class="col-span-2 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <input type="text" data-member-id="${member.id}" data-field="data.other" value="${member.data.other || ''}" placeholder="その他" class="col-span-2 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <input type="text" data-member-id="${member.id}" data-field="data.memo" value="${member.data.memo || ''}" placeholder="備考" class="col-span-2 md:col-span-1 p-1 border rounded shadow-sm text-sm">
                    <div class="col-span-3 md:col-span-1 flex items-center justify-between">
                        <label class="text-sm flex items-center">
                            <input type="checkbox" data-member-id="${member.id}" data-field="isFlagTarget" class="mr-1 rounded shadow-sm" ${member.isFlagTarget ? 'checked' : ''}>
                            同乗優先
                        </label>
                        <!-- ★ 修正: ボタンサイズ変更 -->
                        <button data-action="delete-member" data-member-id="${member.id}" class="text-xs bg-red-500 hover:bg-red-600 text-white py-0.5 px-2 rounded">削除</button>
                    </div>
                </div>
            `).join('');

            const moveUpDisabled = (index === 0) ? 'disabled' : '';
            const moveDownDisabled = (index === totalCount - 1) ? 'disabled' : '';
            const moveButtons = `
                <!-- ★ 修正: ボタンサイズ変更 -->
                <div class="flex flex-col space-y-1">
                    <button data-action="move-up" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-0.5 px-1 rounded disabled:opacity-30 disabled:cursor-not-allowed" ${moveUpDisabled}>▲ 上へ</button>
                    <button data-action="move-down" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-0.5 px-1 rounded disabled:opacity-30 disabled:cursor-not-allowed" ${moveDownDisabled}>▼ 下へ</button>
                </div>
            `;
            
            familyCard.innerHTML = `
                <div class="family-header">
                    <input type="text" data-action="rename-family" value="${family.familyName}" class="text-lg font-semibold p-1 border rounded shadow-sm">
                    <div class="flex items-center space-x-2">
                        ${moveButtons}
                        <!-- ★ 修正: ボタンサイズ変更 -->
                        <button data-action="delete-family" class="text-xs bg-red-500 hover:bg-red-600 text-white py-0.5 px-2 rounded">家族を削除</button>
                    </div>
                </div>
                <div class="family-content">
                    <div class="space-y-2 mb-3">
                        ${membersHtml}
                    </div>
                    <!-- ★ 修正: ボタンサイズ変更 -->
                    <button data-action="add-member" class="text-xs bg-blue-500 hover:bg-blue-600 text-white py-0.5 px-2 rounded">
                        ＋ メンバー追加
                    </button>
                </div>
            `;
            return familyCard;
        }
        
        // --- 家族データの操作 ---
        async function handleAddFamily() {
            const newFamilyName = prompt("新しい家族名を入力してください (例: 鈴木家)");
            if (!newFamilyName || newFamilyName.trim() === '') {
                showWarningMessage("家族名が入力されていません。");
                return;
            }
            try {
                const existingFamily = await db.getFamily(newFamilyName);
                if (existingFamily) {
                    showErrorMessage(`家族名「${newFamilyName}」は既に使用されています。`);
                    return;
                }
                
                const families = await db.getAllFamilies();
                const maxOrder = families.reduce((max, f) => Math.max(max, f.order ?? 0), 0);

                const newFamily = {
                    familyName: newFamilyName,
                    order: maxOrder + 1, 
                    members: [
                        {
                            id: `p${Date.now()}`,
                            name: "新しいメンバー",
                            type: "選手",
                            isFlagTarget: true,
                            data: { grade: "", school: "", other: "", memo: "" }
                        }
                    ]
                };
                await db.addFamily(newFamily);
                await loadFamilies();
                showSuccessMessage(`家族「${newFamilyName}」を追加しました。`);
            } catch (err) {
                console.error('Failed to add family:', err);
                showErrorMessage('家族の追加に失敗しました。');
            }
        }

        async function handleFamilyAction(e) {
            const target = e.target;
            const action = target.dataset.action;
            const familyCard = target.closest('[data-family-id]');
            if (!familyCard) return;
            
            const familyName = familyCard.dataset.familyId;

            try {
                const family = await db.getFamily(familyName);
                if (!family) {
                    showErrorMessage('対象の家族データが見つかりません。');
                    await loadFamilies();
                    return;
                }

                if (action === 'delete-family') {
                    if (confirm(`本当に「${familyName}」を削除しますか？`)) {
                        await db.deleteFamily(familyName);
                        await loadFamilies();
                        showSuccessMessage(`家族「${familyName}」を削除しました。`);
                    }
                } else if (action === 'add-member') {
                    const newMember = {
                        id: `p${Date.now()}`,
                        name: "新しいメンバー",
                        type: "保護者",
                        isFlagTarget: false,
                        data: { grade: "", school: "", other: "", memo: "" }
                    };
                    family.members.push(newMember);
                    await db.updateFamily(family);
                    await loadFamilies(); // 再描画
                    showSuccessMessage('メンバーを追加しました。');
                } else if (action === 'delete-member') {
                    const memberId = target.dataset.memberId;
                    if (confirm("本当にこのメンバーを削除しますか？")) {
                        family.members = family.members.filter(m => m.id !== memberId);
                        await db.updateFamily(family);
                        await loadFamilies(); // 再描画
                        showSuccessMessage('メンバーを削除しました。');
                    }
                } else if (action === 'rename-family') {
                    target.addEventListener('change', async (event) => {
                        const newName = event.target.value.trim();
                        if (newName === '' || newName === familyName) {
                            event.target.value = familyName; 
                            return;
                        }
                        
                        const existing = await db.getFamily(newName);
                        if (existing) {
                            event.target.value = familyName; 
                            showErrorMessage(`家族名「${newName}」は既に使用されています。`);
                            return;
                        }

                        await db.deleteFamily(familyName);
                        family.familyName = newName;
                        await db.addFamily(family); 
                        
                        familyCard.dataset.familyId = newName; 
                        showSuccessMessage('家族名を変更しました。');
                    }, { once: true }); 
                }
                
                if (action === 'move-up' || action === 'move-down') {
                    try {
                        const families = (await db.getAllFamilies()).sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
                        const currentIndex = families.findIndex(f => f.familyName === familyName);
                        
                        if (currentIndex === -1) return;

                        const targetIndex = (action === 'move-up') ? currentIndex - 1 : currentIndex + 1;
                        
                        if (targetIndex >= 0 && targetIndex < families.length) {
                            const familyA = families[currentIndex];
                            const familyB = families[targetIndex];
                            
                            const tempOrder = familyA.order;
                            familyA.order = familyB.order;
                            familyB.order = tempOrder;
                            
                            await db.updateFamily(familyA);
                            await db.updateFamily(familyB);
                            
                            await loadFamilies();
                            showSuccessMessage('並び順を変更しました');
                        }
                    } catch (err) {
                        console.error('Failed to reorder family:', err);
                        showErrorMessage('並び順の変更に失敗しました。');
                    }
                }

            } catch (err) {
                console.error('Family action failed:', err);
                showErrorMessage('操作に失敗しました。');
            }
        }

        async function handleMemberInput(e) {
            const target = e.target;
            const memberId = target.dataset.memberId;
            const field = target.dataset.field;
            if (!memberId || !field) return;

            const familyName = target.closest('[data-family-id]').dataset.familyId;
            
            try {
                const family = await db.getFamily(familyName);
                if (!family) return;

                const member = family.members.find(m => m.id === memberId);
                if (!member) return;

                let value;
                if (target.type === 'checkbox') {
                    value = target.checked;
                } else {
                    value = target.value;
                }

                if (field.startsWith('data.')) {
                    const dataField = field.split('.')[1];
                    member.data[dataField] = value;
                } else {
                    member[field] = value;
                }

                await db.updateFamily(family);
            } catch (err) {
                console.error('Failed to update member:', err);
                showErrorMessage('メンバー情報の更新に失敗しました。');
            }
        }

        // --- 車データの読み込みと描画 ---
        async function loadCars() {
            try {
                const cars = await db.getAllCars();
                cars.sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
                renderCars(cars);
            } catch (err) {
                console.error('Failed to load cars:', err);
                carLoadingMessage.textContent = "車データの読み込みに失敗しました。";
                carLoadingMessage.classList.add('text-red-500');
            }
        }

        function renderCars(cars) {
            carListEl.innerHTML = '';
            if (cars.length === 0) {
                carLoadingMessage.textContent = "データがありません。「新しい車を追加」ボタンから登録してください。";
                carListEl.appendChild(carLoadingMessage);
                return;
            }
            
            cars.forEach((car, index) => {
                const carCard = document.createElement('div');
                carCard.className = 'p-4 border rounded-lg bg-gray-50 flex flex-wrap gap-4 items-center';
                carCard.dataset.carId = car.id;
                
                const moveUpDisabled = (index === 0) ? 'disabled' : '';
                const moveDownDisabled = (index === cars.length - 1) ? 'disabled' : '';
                const moveButtons = `
                    <!-- ★ 修正: ボタンサイズ変更 -->
                    <div class="flex flex-col space-y-1">
                        <button data-action="move-up" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-0.5 px-1 rounded disabled:opacity-30 disabled:cursor-not-allowed" ${moveUpDisabled}>▲ 上へ</button>
                        <button data-action="move-down" class="text-xs bg-gray-400 hover:bg-gray-500 text-white py-0.5 px-1 rounded disabled:opacity-30 disabled:cursor-not-allowed" ${moveDownDisabled}>▼ 下へ</button>
                    </div>
                `;

                carCard.innerHTML = `
                    ${moveButtons}
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700">車ID</label>
                        <input type="text" data-field="id" value="${car.id}" class="mt-1 w-full p-1 border rounded shadow-sm text-sm bg-gray-200" readonly>
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700">車の名称</label>
                        <input type="text" data-field="name" value="${car.name}" class="mt-1 w-full p-1 border rounded shadow-sm text-sm">
                    </div>
                    <div class="flex-1 min-w-[150px]">
                        <label class="block text-sm font-medium text-gray-700">関連家族名</label>
                        <input type="text" data-field="familyName" value="${car.familyName}" class="mt-1 w-full p-1 border rounded shadow-sm text-sm">
                    </div>
                    <div class="flex-1 min-w-[100px]">
                        <label class="block text-sm font-medium text-gray-700">基本定員</label>
                        <input type="number" data-field="baseCapacity" value="${car.baseCapacity}" class="mt-1 w-full p-1 border rounded shadow-sm text-sm">
                    </div>
                    <div class="ml-auto">
                        <!-- ★ 修正: ボタンサイズ変更 -->
                        <button data-action="delete-car" class="text-xs bg-red-500 hover:bg-red-600 text-white py-0.5 px-2 rounded">削除</button>
                    </div>
                `;
                carListEl.appendChild(carCard);
            });
        }

        // --- 車データの操作 ---
        async function handleAddCar() {
            const newCarId = `c${Date.now()}`;
            
            try {
                const cars = await db.getAllCars();
                const maxOrder = cars.reduce((max, c) => Math.max(max, c.order ?? 0), 0);
                
                const newCar = {
                    id: newCarId,
                    name: "新しい車",
                    familyName: "スタッフ・個人",
                    baseCapacity: 5,
                    order: maxOrder + 1 
                };
                await db.addCar(newCar);
                await loadCars();
                showSuccessMessage(`車「${newCar.name}」を追加しました。`);
            } catch (err) {
                console.error('Failed to add car:', err);
                showErrorMessage('車の追加に失敗しました。');
            }
        }

        async function handleCarAction(e) {
            const target = e.target;
            const action = target.dataset.action;
            const carCard = target.closest('[data-car-id]');
            if (!carCard) return;

            const carId = carCard.dataset.carId;

            try {
                if (action === 'delete-car') {
                    if (confirm(`本当に車(ID: ${carId})を削除しますか？`)) {
                        await db.deleteCar(carId);
                        await loadCars();
                        showSuccessMessage(`車(ID: ${carId})を削除しました。`);
                    }
                }
                
                if (action === 'move-up' || action === 'move-down') {
                    try {
                        const cars = (await db.getAllCars()).sort((a, b) => (a.order ?? 999) - (b.order ?? 999));
                        const currentIndex = cars.findIndex(c => c.id === carId);
                        
                        if (currentIndex === -1) return;

                        const targetIndex = (action === 'move-up') ? currentIndex - 1 : currentIndex + 1;
                        
                        if (targetIndex >= 0 && targetIndex < cars.length) {
                            const carA = cars[currentIndex];
                            const carB = cars[targetIndex];
                            
                            const tempOrder = carA.order;
                            carA.order = carB.order;
                            carB.order = tempOrder;
                            
                            await db.updateCar(carA);
                            await db.updateCar(carB);
                            
                            await loadCars();
                            showSuccessMessage('並び順を変更しました');
                        }
                    } catch (err) {
                        console.error('Failed to reorder car:', err);
                        showErrorMessage('並び順の変更に失敗しました。');
                    }
                }

            } catch (err) {
                console.error('Car action failed:', err);
                showErrorMessage('操作に失敗しました。');
            }
        }

        async function handleCarInput(e) {
            const target = e.target;
            const field = target.dataset.field;
            if (!field || field === 'id') return; 

            const carId = target.closest('[data-car-id]').dataset.carId;
            
            try {
                const car = await db.getCar(carId);
                if (!car) return;

                let value = target.value;
                if (target.type === 'number') {
                    value = parseInt(value, 10);
                }
                
                car[field] = value;

                await db.updateCar(car);
            } catch (err) {
                console.error('Failed to update car:', err);
                showErrorMessage('車情報の更新に失敗しました。');
            }
        }
        
        // --- ★ 新規: 駐車場データの読み込みと描画 ---
        async function loadParking() {
            try {
                const parkingList = await db.getAllSavedParking();
                // タイムスタンプの降順（新しい順）でソート
                parkingList.sort((a, b) => (b.timestamp ?? 0) - (a.timestamp ?? 0));
                renderParkingList(parkingList);
            } catch (err) {
                console.error('Failed to load parking data:', err);
                parkingLoadingMessage.textContent = "駐車場データの読み込みに失敗しました。";
                parkingLoadingMessage.classList.add('text-red-500');
            }
        }

        function renderParkingList(parkingList) {
            parkingListEl.innerHTML = '';
            if (parkingList.length === 0) {
                parkingLoadingMessage.textContent = "データがありません。「新しい駐車場を追加」ボタンから登録してください。";
                parkingListEl.appendChild(parkingLoadingMessage);
                return;
            }
            
            parkingList.forEach((parkingItem) => {
                const park = parkingItem.parking; // データは 'parking' プロパティの中
                if (!park) return; // データ破損防止
                
                const card = document.createElement('div');
                card.className = 'p-4 border rounded-lg bg-gray-50 space-y-2';
                card.dataset.parkingId = parkingItem.id;

                card.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-500">保存名</label>
                            <input type="text" data-field="name" value="${parkingItem.name}" class="w-full p-1 border rounded shadow-sm text-sm">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-500">グラウンド名</label>
                            <input type="text" data-field="parking.groundName" value="${park.groundName || ''}" class="w-full p-1 border rounded shadow-sm text-sm">
                        </div>
                        <div class="md:col-span-1 flex justify-end items-center">
                            <span class="text-xs text-gray-400 mr-4">ID: ${parkingItem.id}</span>
                            <button data-action="delete-parking" class="text-xs bg-red-500 hover:bg-red-600 text-white py-0.5 px-2 rounded">削除</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-500">指定駐車場 名</label>
                            <input type="text" data-field="parking.designated.name" value="${park.designated?.name || ''}" class="w-full p-1 border rounded shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500">台数制限</label>
                            <input type="number" data-field="parking.designated.limit" value="${park.designated?.limit || 0}" class="w-full p-1 border rounded shadow-sm text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500">指定以外 名</label>
                            <input type="text" data-field="parking.other.name" value="${park.other?.name || ''}" class="w-full p-1 border rounded shadow-sm text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                         <div>
                            <label class="block text-xs font-medium text-gray-500">指定駐車場 メモ</label>
                            <textarea data-field="parking.designated.memo" rows="2" class="w-full p-1 border rounded shadow-sm text-sm">${park.designated?.memo || ''}</textarea>
                        </div>
                         <div>
                            <label class="block text-xs font-medium text-gray-500">指定以外 メモ</label>
                            <textarea data-field="parking.other.memo" rows="2" class="w-full p-1 border rounded shadow-sm text-sm">${park.other?.memo || ''}</textarea>
                        </div>
                    </div>
                `;
                parkingListEl.appendChild(card);
            });
        }

        // --- ★ 新規: 駐車場データの操作 ---
        async function handleAddParking() {
            const defaultName = `新規グラウンド ${new Date().toLocaleDateString('ja-JP')}`;
            const name = prompt("新しい駐車場データの保存名を入力してください:", defaultName);
            if (!name || name.trim() === '') {
                showWarningMessage("保存名が入力されていません。");
                return;
            }

            const newParkingData = {
                groundName: "（グラウンド名未入力）",
                designated: { name: "（指定駐車場）", limit: 0, memo: "" },
                other: { name: "（その他駐車場）", memo: "" }
            };

            try {
                // db.saveParking は db.add を使い、timestamp も自動付与する
                await db.saveParking(newParkingData, name);
                await loadParking();
                showSuccessMessage(`駐車場「${name}」を追加しました。`);
            } catch (err) {
                console.error('Failed to add parking data:', err);
                showErrorMessage('駐車場データの追加に失敗しました。');
            }
        }

        async function handleParkingAction(e) {
            const target = e.target;
            const action = target.dataset.action;
            const card = target.closest('[data-parking-id]');
            if (!card) return;

            const parkingId = parseInt(card.dataset.parkingId, 10);
            if (isNaN(parkingId)) return;

            try {
                if (action === 'delete-parking') {
                    const parkingItem = await db.getParking(parkingId);
                    const name = parkingItem ? parkingItem.name : `ID: ${parkingId}`;
                    if (confirm(`本当に駐車場データ「${name}」を削除しますか？`)) {
                        await db.deleteParking(parkingId);
                        await loadParking();
                        showSuccessMessage(`駐車場データを削除しました。`);
                    }
                }
            } catch (err) {
                console.error('Parking action failed:', err);
                showErrorMessage('操作に失敗しました。');
            }
        }
        
        async function handleParkingInput(e) {
            const target = e.target;
            const field = target.dataset.field;
            if (!field) return;

            const card = target.closest('[data-parking-id]');
            const parkingId = parseInt(card.dataset.parkingId, 10);
            if (isNaN(parkingId)) return;
            
            try {
                const parkingItem = await db.getParking(parkingId);
                if (!parkingItem) return;

                let value = target.value;
                if (target.type === 'number') {
                    value = parseInt(value, 10) || 0;
                }

                // 'parking.designated.name' のようなネストしたプロパティに対応
                const fields = field.split('.');
                if (fields.length === 1) { // name
                    parkingItem[fields[0]] = value;
                } else if (fields.length === 2) { // parking.groundName
                    if (!parkingItem[fields[0]]) parkingItem[fields[0]] = {}; // parking オブジェクトがない場合
                    parkingItem[fields[0]][fields[1]] = value;
                } else if (fields.length === 3) { // parking.designated.name
                    if (!parkingItem[fields[0]]) parkingItem[fields[0]] = {};
                    if (!parkingItem[fields[0]][fields[1]]) { // designated や other がない場合
                         parkingItem[fields[0]][fields[1]] = {};
                    }
                    parkingItem[fields[0]][fields[1]][fields[2]] = value;
                }

                await db.updateParking(parkingItem); // db.js に updateParking を追加済み
            } catch (err) {
                console.error('Failed to update parking data:', err);
                showErrorMessage('駐車場情報の更新に失敗しました。');
            }
        }

        // --- インポート/エクスポート ---
        async function handleExportMasterData() {
            try {
                const families = await db.getAllFamilies();
                const cars = await db.getAllCars();
                const parking = await db.getAllSavedParking(); 
                
                const masterData = { 
                    families: families, 
                    cars: cars,
                    parking: parking 
                }; 
                const jsonString = JSON.stringify(masterData, null, 2); 
                
                const blob = new Blob([jsonString], { type: 'application/json' }); 
                const url = URL.createObjectURL(blob); 
                const a = document.createElement('a'); 
                a.href = url; 
                a.download = `car_assignment_master_${new Date().toISOString().slice(0,10)}.json`; 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
                URL.revokeObjectURL(url); 
                showSuccessMessage('現在のマスターデータをファイルに保存しました。');
            } catch (err) {
                 console.error('Failed to export master data:', err);
                showErrorMessage('マスターデータのエクスポートに失敗しました。');
            }
        }
        
        function handleImportMasterData(e) {
             const file = e.target.files[0];
             if (!file) return;
             
             const reader = new FileReader();

             reader.onload = async (event) => {
                 try {
                     const masterData = JSON.parse(event.target.result);

                    if (!masterData || !Array.isArray(masterData.families) || !Array.isArray(masterData.cars)) {
                        throw new Error('JSONの形式が正しくありません。 "families" と "cars" の配列が必須です。');
                    }
                     
                     masterData.families.forEach((f, i) => {
                         if (f.order === undefined) f.order = i + 1;
                     });
                     masterData.cars.forEach((c, i) => {
                         if (c.order === undefined) c.order = i + 1;
                     });
                     
                     await db.clearStore('families');
                     await db.clearStore('cars');
                     
                     await db.bulkAddFamilies(masterData.families);
                     await db.bulkAddCars(masterData.cars);

                     if (masterData.parking && Array.isArray(masterData.parking)) {
                         await db.clearStore('savedParking');
                         for (const park of masterData.parking) {
                             // ID を削除して autoIncrement で再採番させる
                             // (インポート元とIDが重複するのを防ぐため)
                             if (park.id) {
                                 delete park.id;
                             }
                             // 形式チェック (name と parking があるか)
                             if (park.name && park.parking) {
                                 // addParking は {name, parking, timestamp} を期待する
                                 // db.addParking は (item) を受け取るので、item 自体を渡す
                                 await db.addParking(park); 
                             }
                         }
                     }

                     await loadFamilies();
                     await loadCars();
                     await loadParking(); // ★ 新規
                     
                     showSuccessMessage('マスターデータを読み込みました。');
                 } catch (err) { 
                     console.error('Error parsing master data JSON:', err); 
                     showErrorMessage(`マスターデータの読み込みに失敗しました: ${err.message}`); 
                 } 
                 e.target.value = null; 
             };
             reader.readAsText(file);
        }

        // --- メッセージ表示 ---
        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }
        function showWarningMessage(message) {
            showMessage(message, 'warning');
        }
        function showErrorMessage(message) {
            showMessage(message, 'error');
        }
        
        function showMessage(message, type = 'info'){ 
            messageText.innerHTML = message; 
            messageContainer.className = 'p-4 mb-4 border rounded-lg'; 
            switch(type) {
                case 'error': messageContainer.classList.add('bg-red-100', 'border-red-400', 'text-red-700'); break;
                case 'warning': messageContainer.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700'); break;
                case 'success': messageContainer.classList.add('bg-green-100', 'border-green-400', 'text-green-700'); break;
                default: messageContainer.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            messageContainer.classList.remove('hidden');
        }
        function hideMessage(){ 
            messageContainer.classList.add('hidden');
        }
    </script>

</body>
</html>
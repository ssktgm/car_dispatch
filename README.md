# 配車調整アプリ 設計書

## 1. アプリ概要

本アプリは、スポーツチームの遠征やイベントにおける車両の配車割り当てを効率化するためのウェブアプリケーション（PWA対応）である。
参加者リスト、利用可能な車、駐車場の情報を基に、最適な配車案を自動生成し、手動での微調整も可能にする。

データはすべてクライアントサイド（ブラウザ内）の IndexedDB に保存され、サーバーを必要としない。

## 2. 主な機能

### 2.1. メイン機能 (index.html)

**参加者の選択:**

* マスターデータ（家族・参加者）を一覧表示。
* 家族単位での「全員参加/不参加」の一括選択。
* 参加者ごとの参加可否を選択。
* 「同乗優先」がオンの参加者（選手など）に対し、「学年」「学校」「その他」の属性情報を入力。

**車とドライバーの選択:**

* マスターデータ（車）を一覧表示。
* 利用する車を選択。
* 各車にドライバーを割り当て（関連家族から候補を優先表示）。
* 「荷物あり」オプション（定員を2名に制限）の選択。

**別便の除外:**

* 参加者のうち、配車が不要な人（現地集合など）を選択から除外。

**駐車場情報と割り当て実行:**

* 目的地の「グラウンド名」を入力。
* 「指定駐車場」（名称、台数制限、備考）と「指定以外の駐車場」（名称、備考）を入力。
* 「割り当て実行」ボタンで、自動配車アルゴリズムを実行。

**割り当て結果の表示:**

* 駐車場（指定／指定以外／別便）ごとに、割り当てられた車と乗員をカード形式で表示。
* 定員オーバーやドライバー不在などの警告を表示。

**手動調整（スワップ）:**

* 乗員同士（空席、別便含む）をチェックボックスで選択し、入れ替え。
* ドライバー（空席含む）と乗員をチェックボックスで選択し、入れ替え。
* 車同士をチェックボックスで選択し、駐車場（指定／指定以外）または表示順序を入れ替え。

**テキスト出力:**

* 割り当て結果をLINEなどで共有しやすいプレーンテキスト形式で生成・コピー。

### 2.2. データ管理機能 (index.html)

**作業状態の保存・復元 (IndexedDB):**

* 現在の作業状態（全ステップの入力内容）に名前を付けてDBに保存（最大50件）。
* 保存した状態をドロップダウンから選択して復元。
* 保存した状態を個別に削除。

**駐車場データの保存・復元 (IndexedDB):**

* ステップ4の駐車場・グラウンド入力内容に名前を付けてDBに保存（最大100件）。
* 保存したデータをドロップダウンから選択して入力欄に反映。
* 保存したデータを個別に削除。

**状態のファイル入出力 (JSON):**

* 現在の作業状態をJSONファイルとしてエクスポート。
* JSONファイルから作業状態をインポート。

**全データ初期化:**

* IndexedDB内の全データ（マスター、状態、駐車場）を削除し、デフォルトのマスターデータで再初期化する「キャッシュ全クリア」機能。

### 2.3. マスターデータ管理機能 (master.html)

**家族・参加者管理:**

* 家族・グループの追加、削除、名称変更。
* 家族・グループの表示順序の変更（▲ ▼ボタン）。
* メンバー（参加者）の追加、削除、情報（名前、タイプ）変更。
* メンバーの「同乗優先」フラグ（isFlagTarget）の切り替え。
* メンバーの属性データ（学年、学校、備考など）の編集。

**車管理:**

* 車の追加（ID自動生成）、削除、情報（名前、定員）変更。
* 車と家族の関連付け。
* 車の表示順序の変更（▲ ▼ボタン）。

**マスターデータのファイル入出力 (JSON):**

* DB内の全マスターデータ（家族、車、保存済み駐車場）を単一のJSONファイルとしてエクスポート。
* JSONファイルからマスターデータをインポート（既存データは上書き）。

### 2.4. PWA (プログレッシブウェブアプリ) 機能

**サービスワーカー (sw.js):**

* アプリのコアファイル（HTML, JS, CSS）とTailwind CSSをキャッシュ。
* オフラインでもアプリの起動・利用が可能（ネットワークファースト戦略）。

**マニフェスト (manifest.json):**

* アプリ名、アイコン、テーマカラーを定義。
* スマートフォンやPCの「ホーム画面に追加」（インストール）に対応。

## 3. データ構造 (IndexedDB)

データベース名: `CarAppDB` (バージョン 3)

### 3.1. オブジェクトストア（テーブル）

| ストア名 | キーパス | 説明 |
| :--- | :--- | :--- |
| families | familyName | 家族・参加者マスターデータ |
| cars | id | 車マスターデータ |
| saved\_states | id | 保存された作業状態（JSON） |
| saved\_parking | id | 保存された駐車場・グラウンドデータ |

### 3.2. データスキーマ（例）

**families ストア (Family)**

```json
{
  "familyName": "小高家",
  "order": 1,
  "members": [
    {
      "id": "p1",
      "name": "斗愛",
      "type": "選手",
      "isFlagTarget": true,
      "data": { "grade": "5年", "school": "東小", "other": "", "memo": "" }
    },
    {
      "id": "p2",
      "name": "小高監督",
      "type": "保護者",
      "isFlagTarget": false,
      "data": { "memo": "" }
    }
  ]
}
```

**cars ストア (Car)**

```json
{
  "id": "c1",
  "name": "小高カー",
  "familyName": "小高家",
  "baseCapacity": 6,
  "order": 1
}
```

**saved_states ストア (State)**

```json
{
  "id": "state_1678886400000",
  "timestamp": 1678886400000,
  "name": "4/1 練習試合",
  "data": {
    "selectedParticipantIds": ["p1", "p2", "p4"],
    "selectedCarIds": ["c1"],
    "selectedDrivers": [["c1", "p2"]],
    "selectedLuggage": ["c1"],
    "excludedParticipantIds": [],
    "participantData": [
      ["p1", { "grade": "5年", "school": "東小", "other": "", "memo": "お迎え" }]
    ],
    "parkingInfo": {
      "groundName": "SF",
      "designated": { "name": "A面", "limit": 6, "memo": "..." },
      "other": {}
    },
    "currentAssignments": []
  }
}
```

**saved_parking ストア (Parking)**

```json
{
  "id": "parking_1678886500000",
  "timestamp": 1678886500000,
  "name": "ホーム (SF)",
  "groundName": "SF (ホーム)",
  "designatedName": "SF-A面",
  "limit": 6,
  "designatedMemo": "コミュニティプラザテニスコート脇③",
  "otherName": "丘の上",
  "otherMemo": "テニスコート奥"
}
```